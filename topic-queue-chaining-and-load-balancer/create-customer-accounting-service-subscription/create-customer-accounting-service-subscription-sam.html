<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta property="og:title" content="Wild Rydes Asynchronous Messaging Workshop"><meta property="og:type" content="website"><meta property="og:url" content><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.83.1"><meta name=description content="Wild Rydes Asynchronous Messaging Workshop"><meta name=author content="Jane Architect"><link rel="shortcut icon" href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><link rel=icon href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><title>SAM :: Wild Rydes Asynchronous Messaging Workshop</title><link href=../../css/nucleus.css rel=stylesheet><link href=../../css/fontawesome-all.min.css rel=stylesheet><link href=../../css/hybrid.css rel=stylesheet><link href=../../css/featherlight.min.css rel=stylesheet><link href=../../css/perfect-scrollbar.min.css rel=stylesheet><link href=../../css/auto-complete.css rel=stylesheet><link href=../../css/atom-one-dark-reasonable.css rel=stylesheet><link href=../../css/theme.css rel=stylesheet><link href=../../css/hugo-theme.css rel=stylesheet><link href=../../css/theme-aws.css rel=stylesheet><link href=../../css/jquery-ui.min.css rel=stylesheet><script src=../../js/jquery-3.5.1.min.js></script><script src=../../js/jquery-ui-1.12.1.min.js></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=../../topic-queue-chaining-and-load-balancer/create-customer-accounting-service-subscription/create-customer-accounting-service-subscription-sam.html><nav id=sidebar><div id=header-wrapper><div id=header><div><a href=../../ title="Go home"><img style=vertical-align:middle src=../../images/logo.png height=70px></a></div></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../../js/lunr.min.js></script><script type=text/javascript src=../../js/auto-complete.js></script><script type=text/javascript>var baseurl="https://marcinbelczewski.github.io/asynchronous-messaging-workshop/"</script><script type=text/javascript src=../../js/search.js></script></div><div class=highlightable><ul class=topics><li data-nav-id=/prerequisites.html title="Workshop Prerequisites" class=dd-item><a href=../../prerequisites.html>Workshop Prerequisites</a><ul><li data-nav-id=/prerequisites/prerequisites-1.html title="Account Setup" class=dd-item><a href=../../prerequisites/prerequisites-1.html>Account Setup</a><ul></ul></li><li data-nav-id=/prerequisites/prerequisites-2/prerequisites-2.html title="Configure AWS Cloud9" class=dd-item><a href=../../prerequisites/prerequisites-2/prerequisites-2.html>Configure AWS Cloud9</a></li></ul></li><li data-nav-id=/choose-your-own-advanture.html title="Choose Your Own Adventure" class=dd-item><a href=../../choose-your-own-advanture.html>Choose Your Own Adventure</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer.html title="Topic-Queue Chaining & Load Balancing" class="dd-item
parent"><a href=../../topic-queue-chaining-and-load-balancer.html>Lab-2: Topic-Queue Chaining & Load Balancing</a><ul><li data-nav-id=/topic-queue-chaining-and-load-balancer/bootstrap-initial-state/bootstrap-initial-state.html title="Bootstrap the Initial State" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/bootstrap-initial-state/bootstrap-initial-state.html>1 Bootstrap the Initial State</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/create-sns-topic/create-sns-topic.html title="Create the Amazon SNS topic" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/create-sns-topic/create-sns-topic.html>2 Create the Amazon SNS topic</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/create-customer-notification-service-subscription/create-customer-notification-service-subscription.html title="Create Customer Notification Service Subscription" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/create-customer-notification-service-subscription/create-customer-notification-service-subscription.html>3 Create Customer Notification Service Subscription</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/create-customer-accounting-service-subscription/create-customer-accounting-service-subscription.html title="Create Customer Accounting Service Subscription" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/create-customer-accounting-service-subscription/create-customer-accounting-service-subscription.html>4 Create Customer Accounting Service Subscription</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/create-extraordinary-rides-service-subscription/create-extraordinary-rides-service-subscription.html title="Create Extraordinary Rides Service Subscription" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/create-extraordinary-rides-service-subscription/create-extraordinary-rides-service-subscription.html>5 Create Extraordinary Rides Service Subscription</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/update-unicorn-management-service/update-unicorn-management-service.html title="Update Unicorn Management Service" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/update-unicorn-management-service/update-unicorn-management-service.html>6 Update Unicorn Management Service</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/test-topic-queue-chaining-and-load-balancer/test-topic-queue-chaining-and-load-balancing.html title="Test Topic-Queue Chaining & Load Balancing" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/test-topic-queue-chaining-and-load-balancer/test-topic-queue-chaining-and-load-balancing.html>7 Test Topic-Queue Chaining & Load Balancing</a></li><li data-nav-id=/topic-queue-chaining-and-load-balancer/clean-up/clean-up.html title="Clean up" class=dd-item><a href=../../topic-queue-chaining-and-load-balancer/clean-up/clean-up.html>8 Clean up</a></li></ul></li><li data-nav-id=/resources.html title=Resources class=dd-item><a href=../../resources.html>Resources</a></li></ul><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/marcinbelczewski/asynchronous-messaging-workshop/><i class="fab fa-github"></i> Github repo</a></li></ul></section><section id=footer><left><h5 class=copyright>&copy; 2019 Amazon Web Services, Inc. or its Affiliates. All rights reserved.<h5></left></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://code.amazon.com/packages/AwsSaDeMsgPtnMcrSrv/trees/mainline/--/workshop/content/topic-queue-chaining-and-load-balancer/create-customer-accounting-service-subscription/create-customer-accounting-service-subscription-sam.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span>
<span class=links><a href=https://marcinbelczewski.github.io/asynchronous-messaging-workshop/>Decoupled Microservices</a> > <a href=https://marcinbelczewski.github.io/asynchronous-messaging-workshop/topic-queue-chaining-and-load-balancer.html>Topic-Queue Chaining & Load Balancing</a> > SAM</span></div></div></div><div id=body-inner><h1>SAM</h1><h4 id=1-update-the-aws-sam-template>1. Update the AWS SAM template</h4><p>In your Cloud9 IDE for this workshop, open the SAM template file <code>wild-rydes-async-messaging/lab-2/template.yaml</code>. In the <strong>Resources</strong> section, add the definition for an Amazon SQS queue with the name <strong>CustomerAccountingServiceQueue</strong>, the <strong>CustomerAccountingService</strong> will use to consume messages from. You can find the AWS CloudFormation documentation to do so <strong><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-queues.html>here</a></strong>.</p><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Cheat Sheet</span></div><div class=expand-content style=display:none><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>CustomerAccountingServiceQueue</span>:
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::SQS::Queue</span>
</code></pre></div></div></div><p>The next step, before we can define the subscription, is granting our Amazon SNS topic the permissions to publish messages into this Amazon SQS queue. You can find the AWS CloudFormation documentation to do so <strong><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-policy.html>here</a></strong>.</p><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Cheat Sheet</span></div><div class=expand-content style=display:none><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>CustomerAccountingServiceQueuePolicy</span>:
      <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::SQS::QueuePolicy</span>
      <span style=color:#f92672>Properties</span>:
        <span style=color:#f92672>Queues</span>:
          - !<span style=color:#ae81ff>Ref CustomerAccountingServiceQueue</span>
        <span style=color:#f92672>PolicyDocument</span>:
          <span style=color:#f92672>Statement</span>:
            <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
            <span style=color:#f92672>Principal</span>: <span style=color:#e6db74>&#39;*&#39;</span>
            <span style=color:#f92672>Action</span>: <span style=color:#ae81ff>sqs:SendMessage</span>
            <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#39;*&#39;</span>
            <span style=color:#f92672>Condition</span>:
              <span style=color:#f92672>ArnEquals</span>:
                <span style=color:#f92672>aws:SourceArn</span>: !<span style=color:#ae81ff>Ref RideCompletionTopic</span>
</code></pre></div></div></div><p>Now we are ready to create the Amazon SNS subscription for the <strong>CustomerAccountingService</strong>. You can find the AWS CloudFormation documentation to do so <strong><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-sns-subscription.html>here</a></strong>.</p><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Cheat Sheet</span></div><div class=expand-content style=display:none><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>CustomerAccountingServiceQueueToRidesTopicSubscription</span>:
      <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::SNS::Subscription</span>
      <span style=color:#f92672>Properties</span>:
        <span style=color:#f92672>Endpoint</span>: !<span style=color:#ae81ff>GetAtt CustomerAccountingServiceQueue.Arn</span>
        <span style=color:#f92672>Protocol</span>: <span style=color:#ae81ff>sqs</span>
        <span style=color:#f92672>RawMessageDelivery</span>: <span style=color:#66d9ef>true</span>
        <span style=color:#f92672>TopicArn</span>: !<span style=color:#ae81ff>Ref RideCompletionTopic</span>
</code></pre></div></div></div><p>The next step is to attache an AWS IAM policy tou our <strong>CustomerAccountingService</strong> AWS Lambda function, which grants permission to access our previously created Amazon SQS queue, to consume the messages. You can find the AWS SAM documentation to do so <strong><a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template.html#serverless-sam-template-function>here</a></strong> and <strong><a href=https://github.com/awslabs/serverless-application-model/blob/develop/samtranslator/policy_templates_data/policy_templates.json>here</a></strong>.</p><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Cheat Sheet</span></div><div class=expand-content style=display:none><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      <span style=color:#f92672>Policies</span>:
        - <span style=color:#f92672>SQSPollerPolicy</span>:
            <span style=color:#f92672>QueueName</span>: !<span style=color:#ae81ff>Ref CustomerAccountingServiceQueue</span>
</code></pre></div></div></div><p>Last but not least, we have to declare the <strong>CustomerAccountingServiceQueue</strong> as event source for our <strong>CustomerAccountingService</strong>. You can find the AWS SAM documentation to do so <strong><a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template.html#serverless-sam-template-function>here</a></strong>.</p><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Cheat Sheet</span></div><div class=expand-content style=display:none><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      <span style=color:#f92672>Events</span>:
        <span style=color:#f92672>CustomerAccountingServiceJobQueue</span>:
          <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>SQS</span>
          <span style=color:#f92672>Properties</span>:
            <span style=color:#f92672>Queue</span>: !<span style=color:#ae81ff>GetAtt CustomerAccountingServiceQueue.Arn</span>
            <span style=color:#f92672>BatchSize</span>: <span style=color:#ae81ff>1</span>
</code></pre></div></div></div><div class=expand><div class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})"><i style=font-size:x-small class="fas fa-chevron-right"></i>
<span>Detailed description</span></div><div class=expand-content style=display:none><p><img src=step-1-sam.png alt="Step 1"></p><p><img src=step-2-sam.png alt="Step 2"></p></div></div><h4 id=2-deploy-the-updated-aws-sam-template>2. Deploy the updated AWS SAM template</h4><p>Run the following command to build the lab again, after we have added the Amazon SQS queue and the Amazon SNS subscription:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd ~/environment/wild-rydes-async-messaging/lab-2
sam build</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sam deploy <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --guided <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --stack-name %INITIALS-wild-rydes-async-msg-2 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --capabilities CAPABILITY_IAM</code></pre></div><p>In the meantime while your waiting, you may want to have a look at the AWS SAM template to make yourself familiar with the stack we launched. Just click on the <strong>template.yaml</strong> attachment below to see the content.</p><p>Because AWS SAM will only deploy/update/delete resources which are changed, it only takes a couple of seconds to deploy the new Amazon SQS queue and the Amazon SNS subscription.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-next" href=../../prerequisites.html title="Workshop Prerequisites" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../js/clipboard.min.js></script><script src=../../js/perfect-scrollbar.min.js></script><script src=../../js/perfect-scrollbar.jquery.min.js></script><script src=../../js/jquery.sticky.js></script><script src=../../js/featherlight.min.js></script><script src=../../js/html5shiv-printshiv.min.js></script><script src=../../js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script src=../../js/modernizr.custom-3.6.0.js></script><script src=../../js/learn.js></script><script src=../../js/hugo-learn.js></script><link href=../../mermaid/mermaid.css rel=stylesheet><script src=../../mermaid/mermaid.js></script><script>mermaid.initialize({startOnLoad:!0})</script></body></html>